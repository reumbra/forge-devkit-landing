---
import Container from "@shared/ui/Container.astro";
import Button from "@shared/ui/Button.astro";
import ReumbraLogo from "@shared/ui/ReumbraLogo.astro";
import { navigation } from "@shared/config/navigation";

const { logo, links, cta } = navigation;
---

<nav
	class="fixed inset-x-0 top-0 z-50 bg-nav border-b border-card"
>
	{/* Scroll progress bar */}
	<div
		id="scroll-progress"
		class="absolute bottom-0 left-0 h-[2px] bg-primary transition-none"
		style="width: 0%"
		aria-hidden="true"
	></div>
	<Container class="flex items-center justify-between h-[64px] md:h-[72px]">
		{/* Logo */}
		<a href="#" class="flex items-center gap-2 text-text font-sans text-[15px] font-medium">
			<ReumbraLogo size={18} class="text-secondary" />
			<span>{logo}</span>
		</a>

		{/* Desktop nav links */}
		<ul class="hidden md:flex items-center gap-6">
			{links.map((link) => (
				<li>
					<a
						href={link.href}
						data-nav-link={link.href}
						class="nav-link font-sans text-[14px] font-medium text-text-muted hover:text-white transition-colors duration-300 ease-in-out"
					>
						{link.label}
					</a>
				</li>
			))}
		</ul>

		{/* Desktop CTA */}
		<div class="hidden md:block">
			<Button variant="primary" href={cta.href}>
				{cta.label}
			</Button>
		</div>

		{/* Mobile hamburger */}
		<button
			type="button"
			id="nav-toggle"
			class="md:hidden flex flex-col justify-center items-center w-11 h-11 gap-[5px]"
			aria-label="Toggle menu"
			aria-expanded="false"
		>
			<span class="nav-bar block w-5 h-[2px] bg-text-muted transition-all duration-300 ease-in-out origin-center"></span>
			<span class="nav-bar block w-5 h-[2px] bg-text-muted transition-all duration-300 ease-in-out"></span>
			<span class="nav-bar block w-5 h-[2px] bg-text-muted transition-all duration-300 ease-in-out origin-center"></span>
		</button>
	</Container>

	{/* Mobile menu */}
	<div
		id="nav-menu"
		class="md:hidden hidden bg-nav border-t border-card"
	>
		<Container class="flex flex-col gap-1 py-4">
			{links.map((link) => (
				<a
					href={link.href}
					class="font-sans text-[15px] font-normal text-text-muted hover:text-white transition-colors duration-300 ease-in-out py-3"
				>
					{link.label}
				</a>
			))}
			<Button variant="primary" href={cta.href}>
				{cta.label}
			</Button>
		</Container>
	</div>
</nav>

{/* Mobile menu backdrop — outside nav to avoid stacking context issues */}
<div
	id="nav-backdrop"
	class="fixed inset-0 top-[64px] z-40 hidden bg-black/60 md:hidden"
	aria-hidden="true"
></div>

<script>
	const toggle = document.getElementById("nav-toggle");
	const menu = document.getElementById("nav-menu");
	const backdrop = document.getElementById("nav-backdrop");

	function openMenu() {
		if (!toggle || !menu) return;
		menu.classList.remove("hidden");
		backdrop?.classList.remove("hidden");
		toggle.setAttribute("aria-expanded", "true");
		document.body.style.overflow = "hidden";

		const bars = toggle.querySelectorAll<HTMLSpanElement>(".nav-bar");
		bars[0].style.transform = "translateY(7px) rotate(45deg)";
		bars[1].style.opacity = "0";
		bars[2].style.transform = "translateY(-7px) rotate(-45deg)";
	}

	function closeMenu() {
		if (!toggle || !menu) return;
		menu.classList.add("hidden");
		backdrop?.classList.add("hidden");
		toggle.setAttribute("aria-expanded", "false");
		document.body.style.overflow = "";

		const bars = toggle.querySelectorAll<HTMLSpanElement>(".nav-bar");
		bars[0].style.transform = "";
		bars[1].style.opacity = "1";
		bars[2].style.transform = "";
	}

	if (toggle && menu) {
		toggle.addEventListener("click", () => {
			const isOpen = !menu.classList.contains("hidden");
			isOpen ? closeMenu() : openMenu();
		});

		// Close menu when a link is clicked
		menu.querySelectorAll("a").forEach((link) => {
			link.addEventListener("click", closeMenu);
		});

		// Close menu when backdrop is clicked
		backdrop?.addEventListener("click", closeMenu);
	}

	// ── Scroll progress bar ──
	const progressBar = document.getElementById("scroll-progress");

	function updateProgress() {
		const scrollTop = window.scrollY;
		const docHeight = document.documentElement.scrollHeight - window.innerHeight;
		const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
		if (progressBar) progressBar.style.width = `${progress}%`;
	}

	// ── Active nav link highlighting ──
	const navLinks = document.querySelectorAll<HTMLAnchorElement>("[data-nav-link]");
	const sections = document.querySelectorAll<HTMLElement>("section[id]");

	const observer = new IntersectionObserver(
		(entries) => {
			for (const entry of entries) {
				if (entry.isIntersecting) {
					const id = entry.target.id;
					navLinks.forEach((link) => {
						const isActive = link.getAttribute("data-nav-link") === `#${id}`;
						link.classList.toggle("text-white", isActive);
						link.classList.toggle("text-text-muted", !isActive);
					});
				}
			}
		},
		{ rootMargin: "-20% 0px -60% 0px" },
	);

	sections.forEach((section) => observer.observe(section));

	// ── Back-to-top button + floating CTA ──
	const backToTop = document.getElementById("back-to-top");
	const floatingCta = document.getElementById("floating-cta");

	function toggleFloatingEl(el: HTMLElement | null, show: boolean) {
		if (!el) return;
		el.classList.toggle("opacity-0", !show);
		el.classList.toggle("pointer-events-none", !show);
		el.classList.toggle("translate-y-2", !show);
		el.classList.toggle("opacity-100", show);
		el.classList.toggle("pointer-events-auto", show);
		el.classList.toggle("translate-y-0", show);
	}

	function updateFloatingEls() {
		const show = window.scrollY > window.innerHeight;
		toggleFloatingEl(backToTop, show);
		toggleFloatingEl(floatingCta, show);
	}

	backToTop?.addEventListener("click", () => {
		window.scrollTo({ top: 0, behavior: "smooth" });
	});

	// Throttled scroll handler
	let ticking = false;
	window.addEventListener("scroll", () => {
		if (!ticking) {
			requestAnimationFrame(() => {
				updateProgress();
				updateFloatingEls();
				ticking = false;
			});
			ticking = true;
		}
	});

	// Initial state
	updateProgress();
	updateFloatingEls();
</script>
